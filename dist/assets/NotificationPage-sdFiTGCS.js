import{d as de,ar as ve,r as c,c as me,S as A,a as fe,o as _e,b as f,w as l,u as e,I as pe,e as _,f as ge,g as o,h as he,R as ye,P as ke,l as Ie,A as C,q as be,s as w,a9 as L,v as N,n as g,a2 as Ce,a3 as we,k as d,m as h,x as Se,y as $e,z as xe,t as m,aQ as Ne,C as Re,T,U,aR as Ee,a4 as Oe,ag as Be,K,a5 as Pe,a6 as Ve,a7 as Q,aS as ze,aT as De,aU as Ae,M as X,aV as Le,aW as Te,N as r,j as Ue,ab as Y,aX as He,aY as Me,aZ as je,ac as Fe,ad as ee,_ as qe}from"./index-CaEhcsOJ.js";import{T as H}from"./index-DBI8ZE0l.js";const Je={key:0,class:"loading-container"},We={key:1,class:"error-state"},Ze={key:2},Ge={class:"notification-body"},Ke={class:"reactions-container"},Qe={class:"comments-section"},Xe=["src"],Ye={class:"comment-date"},et={slot:"end",class:"vote-buttons"},tt={class:"vote-count"},at={class:"vote-count"},ot={class:"comment-input-container"},nt=de({__name:"NotificationPage",setup(lt){const te=localStorage.getItem("parisklegg_token")||"",M=localStorage.getItem("parisklegg_user");M&&JSON.parse(M);const ae=ve(),oe=ge(),k=Number(ae.params.id),R=c(!0),E=c(!1),O=c(!1),y=c(!1),S=c(!1),s=c(null),v=c([]),B=c(1),j=c(!0),I=c(""),$=c(null),x=c(!1),P=c(null),F=c(0),ne=["like","heart","thumbs-up"],V=me(()=>{var t,a;return((a=(t=s.value)==null?void 0:t.user_reaction)==null?void 0:a.reaction_type)||null}),q=t=>({like:ee,heart:Fe,"thumbs-up":Y})[t]||ee,J=t=>{if(!t)return"Just now";const a=t.replace(/\.\d{6}Z$/,""),u=new Date(a);if(isNaN(u.getTime()))return"Invalid date";const n=u.toLocaleString("en-US",{month:"short"}),i=u.getDate(),b=String(u.getHours()).padStart(2,"0"),D=String(u.getMinutes()).padStart(2,"0");return"".concat(n," ").concat(i,", ").concat(b,":").concat(D)},W=async()=>{try{R.value=!0,E.value=!1;const t=await _.get("https://school.klgilc.com/api/notifications/".concat(k),{headers:p(),timeout:2e4});s.value=t.data,console.log("Notification loaded:",t.data),t.data.is_read===0&&await _.post("https://school.klgilc.com/api/notifications/".concat(k,"/read"),{},{headers:p(),timeout:1e4}),await z()}catch(t){console.error("Error loading notification:",t),ce(t),E.value=!0}finally{R.value=!1}},z=async(t=1)=>{try{const a=await _.get("https://school.klgilc.com/api/notifications/".concat(k,"/comments"),{params:{page:t},headers:p(),timeout:1e4});t===1?v.value=a.data.data:v.value=[...v.value,...a.data.data],B.value=t,j.value=!!a.data.next_page_url}catch(a){console.error("Error loading comments:",a)}},le=async t=>{await z(B.value+1),t.target.complete()},se=async()=>{if(I.value.trim()){O.value=!0;try{const t=await _.post("https://school.klgilc.com/api/notifications/".concat(k,"/create_comment"),{comment_body:I.value},{headers:p(),timeout:1e4}),a={id:t.data.comment.id,comment_body:t.data.comment.comment_body,created_at:t.data.comment.created_at,user_id:t.data.comment.user_id,user_name:t.data.comment.user_name,avatar:t.data.comment.avatar||null,upvotes_count:0,downvotes_count:0,user_vote:null};v.value.unshift(a),I.value="",s.value&&(s.value.comments_count+=1)}catch(t){console.error("Error adding comment:",t)}finally{O.value=!1}}},ie=async t=>{$.value=t;try{await _.delete("https://school.klgilc.com/api/comments/".concat(t),{headers:p(),timeout:1e4}),v.value=v.value.filter(a=>a.id!==t),s.value&&(s.value.comments_count-=1)}catch(a){console.error("Error deleting comment:",a)}finally{$.value=null}},re=async t=>{V.value===t?await ue():await G(t)},Z=async(t,a)=>{if(!S.value){S.value=!0;try{const u=v.value.findIndex(D=>D.id===t);if(u===-1)return;const n=v.value[u],i=n.user_vote;i===a?(n.user_vote=null,a==="upvote"&&n.upvotes_count--,a==="downvote"&&n.downvotes_count--):(i==="upvote"&&n.upvotes_count--,i==="downvote"&&n.downvotes_count--,n.user_vote=a,a==="upvote"&&n.upvotes_count++,a==="downvote"&&n.downvotes_count++);const b=await _.post("https://school.klgilc.com/api/comments/".concat(t,"/vote"),{vote_type:a},{headers:p(),timeout:1e4});v.value[u]={...v.value[u],upvotes_count:b.data.upvotes_count,downvotes_count:b.data.downvotes_count,user_vote:b.data.user_vote}}catch(u){console.error("Error voting on comment:",u),z(B.value)}finally{S.value=!1}}},G=async t=>{y.value=!0,x.value=!1;try{const a=await _.post("https://school.klgilc.com/api/notifications/".concat(k,"/reactions"),{reaction_type:t},{headers:p(),timeout:1e4});s.value&&(s.value.reaction_counts=a.data.reaction_counts,s.value.user_reaction={reaction_type:t},P.value=a.data.reaction_id,console.log("Reaction added:",P.value))}catch(a){console.error("Error adding reaction:",a)}finally{y.value=!1}},ue=async()=>{y.value=!0;try{const t=await _.delete("https://school.klgilc.com/api/notifications/".concat(k,"/delete_reaction"),{headers:p(),timeout:1e4});s.value&&(s.value.reaction_counts=t.data.reaction_counts,P.value=0,s.value.user_reaction=null)}catch(t){console.error("Error removing reaction:",t)}finally{y.value=!1}},p=()=>({"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer ".concat(te)}),ce=t=>{var a;if(console.error("Error fetching data:",t),_.isAxiosError(t)){if(((a=t.response)==null?void 0:a.status)===401){oe.replace("/"),H.show({text:"Session expired. Please login again",position:"top",duration:"long"});return}if(t.code==="ECONNABORTED"){H.show({text:"Request timeout. Please try again",position:"top"});return}}H.show({text:"Failed to load data. Please try again later",position:"top"})};return A.setOverlaysWebView({overlay:!1}),A.setBackgroundColor({color:"#ffffff"}),A.setStyle({style:fe.Light}),_e(()=>{W(),F.value=localStorage.getItem("global_id")?Number(localStorage.getItem("global_id")):0}),(t,a)=>{const u=ye("ion-buttons");return r(),f(e(pe),null,{default:l(()=>[o(e(be),null,{default:l(()=>[o(e(he),null,{default:l(()=>[o(u,{slot:"start"},{default:l(()=>[o(e(ke))]),_:1}),o(e(Ie),null,{default:l(()=>a[3]||(a[3]=[C(" Notification ",-1)])),_:1,__:[3]})]),_:1})]),_:1}),o(e(X),{fullscreen:!0},{default:l(()=>[R.value?(r(),w("div",Je,[o(e(N),{name:"crescent",color:"primary"})])):E.value?(r(),w("div",We,[o(e(g),{icon:e(Ce),color:"danger",size:"large"},null,8,["icon"]),o(e(we),null,{default:l(()=>a[4]||(a[4]=[d("h3",null,"Error Loading Notification",-1),d("p",null,"Please try again later",-1)])),_:1,__:[4]}),o(e(h),{fill:"clear",onClick:W},{default:l(()=>a[5]||(a[5]=[C("Retry",-1)])),_:1,__:[5]})])):s.value?(r(),w("div",Ze,[o(e(Se),{class:"notification-card"},{default:l(()=>[o(e($e),null,{default:l(()=>[o(e(xe),{class:"notification-title"},{default:l(()=>[C(m(s.value.title),1)]),_:1}),o(e(Ne),null,{default:l(()=>[C(m(J(s.value.created_at)),1)]),_:1})]),_:1}),o(e(Re),null,{default:l(()=>[d("p",Ge,m(s.value.body),1),d("div",Ke,[(r(!0),w(T,null,U(s.value.reaction_counts,(n,i)=>(r(),f(e(h),{key:i,fill:"clear",size:"small",onClick:b=>re(i),color:V.value===i?"primary":"medium",disabled:y.value},{default:l(()=>[y.value&&V.value===i?(r(),f(e(N),{key:0,name:"dots",slot:"start"})):(r(),f(e(g),{key:1,icon:q(i),slot:"start"},null,8,["icon"])),C(" "+m(n),1)]),_:2},1032,["onClick","color","disabled"]))),128)),o(e(h),{fill:"clear",size:"small",onClick:a[0]||(a[0]=n=>x.value=!0),disabled:y.value},{default:l(()=>[o(e(g),{icon:e(Ee),slot:"icon-only"},null,8,["icon"])]),_:1},8,["disabled"])])]),_:1})]),_:1}),d("div",Qe,[o(e(Oe),null,{default:l(()=>[o(e(Be),null,{default:l(()=>[o(e(K),null,{default:l(()=>[C("Comments ("+m(s.value.comments_count)+")",1)]),_:1})]),_:1}),(r(!0),w(T,null,U(v.value,n=>(r(),f(e(Q),{key:n.id,class:"comment-item"},{default:l(()=>[o(e(Ue),{slot:"start",style:{"margin-left":"20px"}},{default:l(()=>[d("img",{src:n.avatar||"/assets/img/default-avatar.svg"},null,8,Xe)]),_:2},1024),o(e(K),null,{default:l(()=>[d("h3",null,m(n.user_name),1),d("p",null,m(n.comment_body),1),d("p",Ye,m(J(n.created_at)),1)]),_:2},1024),d("div",et,[o(e(h),{fill:"clear",size:"small",onClick:i=>Z(n.id,"upvote"),disabled:S.value},{default:l(()=>[o(e(g),{icon:e(Y),color:n.user_vote==="upvote"?"primary":"medium"},null,8,["icon","color"]),d("span",tt,m(n.upvotes_count),1)]),_:2},1032,["onClick","disabled"]),o(e(h),{fill:"clear",size:"small",onClick:i=>Z(n.id,"downvote"),disabled:S.value},{default:l(()=>[o(e(g),{icon:e(He),color:n.user_vote==="downvote"?"danger":"medium"},null,8,["icon","color"]),d("span",at,m(n.downvotes_count),1)]),_:2},1032,["onClick","disabled"])]),n.user_id===F.value?(r(),f(e(h),{key:0,fill:"clear",color:"danger",onClick:i=>ie(n.id),disabled:$.value===n.id},{default:l(()=>[$.value===n.id?(r(),f(e(N),{key:0,name:"dots",slot:"icon-only"})):(r(),f(e(g),{key:1,icon:e(Me),slot:"icon-only"},null,8,["icon"]))]),_:2},1032,["onClick","disabled"])):L("",!0)]),_:2},1024))),128)),o(e(Pe),{onIonInfinite:le,threshold:"100px",disabled:!j.value},{default:l(()=>[o(e(Ve),{"loading-spinner":"bubbles","loading-text":"Loading more comments..."})]),_:1},8,["disabled"])]),_:1})]),d("div",ot,[o(e(Q),null,{default:l(()=>[o(e(ze),{modelValue:I.value,"onUpdate:modelValue":a[1]||(a[1]=n=>I.value=n),placeholder:"Add a comment...","auto-grow":""},null,8,["modelValue"]),o(e(h),{slot:"end",fill:"clear",disabled:!I.value.trim(),onClick:se},{default:l(()=>[O.value?(r(),f(e(N),{key:0,slot:"start",name:"dots"})):L("",!0),o(e(g),{icon:e(De),color:"primary"},null,8,["icon"])]),_:1},8,["disabled"])]),_:1})])])):L("",!0),o(e(Ae),{"is-open":x.value,onDidDismiss:a[2]||(a[2]=n=>x.value=!1)},{default:l(()=>[o(e(X),null,{default:l(()=>[o(e(Le),null,{default:l(()=>[o(e(Te),null,{default:l(()=>[(r(),w(T,null,U(ne,n=>o(e(je),{key:n,size:"auto",onClick:i=>G(n)},{default:l(()=>[o(e(h),{fill:"clear"},{default:l(()=>[o(e(g),{icon:q(n),size:"large"},null,8,["icon"])]),_:2},1024)]),_:2},1032,["onClick"])),64))]),_:1})]),_:1})]),_:1})]),_:1},8,["is-open"])]),_:1})]),_:1})}}}),rt=qe(nt,[["__scopeId","data-v-34892f2b"]]);export{rt as default};
