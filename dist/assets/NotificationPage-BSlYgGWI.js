import{d as ve,ao as me,r as c,c as pe,o as fe,O as _e,a as p,w as l,u as t,I as ge,b as f,e as he,f as we,g as o,h as ye,R as ke,P as Ie,l as be,A as b,q as Ce,s as C,a9 as T,v as N,n as g,a2 as Se,a3 as $e,k as d,m as h,x as xe,y as Ne,z as Re,t as m,aP as Ee,C as De,S as A,T as L,aQ as Oe,a4 as Pe,aR as Ve,K as Q,a5 as ze,a6 as Be,a7 as X,aS as Te,aT as Ae,aU as Le,M as Y,aV as Me,aW as He,N as r,j as Ue,ab as ee,aX as je,aY as Fe,aZ as qe,ac as Je,ad as te,_ as We}from"./index-CbFFUppU.js";import{T as M}from"./index-HY87JrIe.js";const Ze={key:0,class:"loading-container"},Ge={key:1,class:"error-state"},Ke={key:2},Qe={class:"notification-body"},Xe={class:"reactions-container"},Ye={class:"comments-section"},et=["src"],tt={class:"comment-date"},at={slot:"end",class:"vote-buttons"},ot={class:"vote-count"},nt={class:"vote-count"},lt={class:"comment-input-container"},st=ve({__name:"NotificationPage",setup(it){const ae=localStorage.getItem("parisklegg_token")||"",H=localStorage.getItem("parisklegg_user");H&&JSON.parse(H);const oe=me(),ne=he(),y=Number(oe.params.id),R=c(!0),E=c(!1),D=c(!1),w=c(!1),S=c(!1),s=c(null),v=c([]),O=c(1),U=c(!0),k=c(""),$=c(null),x=c(!1),P=c(null),j=c(0),le=["like","heart","thumbs-up"],V=pe(()=>{var e,a;return((a=(e=s.value)==null?void 0:e.user_reaction)==null?void 0:a.reaction_type)||null}),F=e=>({like:te,heart:Je,"thumbs-up":ee})[e]||te,q=e=>{if(!e)return"Just now";const a=e.replace(/\.\d{6}Z$/,""),u=new Date(a);if(isNaN(u.getTime()))return"Invalid date";const n=u.toLocaleString("en-US",{month:"short"}),i=u.getDate(),I=String(u.getHours()).padStart(2,"0"),B=String(u.getMinutes()).padStart(2,"0");return"".concat(n," ").concat(i,", ").concat(I,":").concat(B)},J=async()=>{try{R.value=!0,E.value=!1;const e=await f.get("https://klegg-app-whh7m.ondigitalocean.app/api/notifications/".concat(y),{headers:_(),timeout:2e4});s.value=e.data,console.log("Notification loaded:",e.data),e.data.is_read===0&&await f.post("https://klegg-app-whh7m.ondigitalocean.app/api/notifications/".concat(y,"/read"),{},{headers:_(),timeout:1e4}),await z()}catch(e){console.error("Error loading notification:",e),de(e),E.value=!0}finally{R.value=!1}},z=async(e=1)=>{try{const a=await f.get("https://klegg-app-whh7m.ondigitalocean.app/api/notifications/".concat(y,"/comments"),{params:{page:e},headers:_(),timeout:1e4});e===1?v.value=a.data.data:v.value=[...v.value,...a.data.data],O.value=e,U.value=!!a.data.next_page_url}catch(a){console.error("Error loading comments:",a)}},se=async e=>{await z(O.value+1),e.target.complete()},ie=async()=>{if(k.value.trim()){D.value=!0;try{const e=await f.post("https://klegg-app-whh7m.ondigitalocean.app/api/notifications/".concat(y,"/create_comment"),{comment_body:k.value},{headers:_(),timeout:1e4}),a={id:e.data.comment.id,comment_body:e.data.comment.comment_body,created_at:e.data.comment.created_at,user_id:e.data.comment.user_id,user_name:e.data.comment.user_name,avatar:e.data.comment.avatar||null,upvotes_count:0,downvotes_count:0,user_vote:null};v.value.unshift(a),k.value="",s.value&&(s.value.comments_count+=1)}catch(e){console.error("Error adding comment:",e)}finally{D.value=!1}}},re=async e=>{$.value=e;try{await f.delete("https://klegg-app-whh7m.ondigitalocean.app/api/comments/".concat(e),{headers:_(),timeout:1e4}),v.value=v.value.filter(a=>a.id!==e),s.value&&(s.value.comments_count-=1)}catch(a){console.error("Error deleting comment:",a)}finally{$.value=null}},ue=async e=>{V.value===e?await ce():await Z(e)},W=async(e,a)=>{if(!S.value){S.value=!0;try{const u=v.value.findIndex(B=>B.id===e);if(u===-1)return;const n=v.value[u],i=n.user_vote;i===a?(n.user_vote=null,a==="upvote"&&n.upvotes_count--,a==="downvote"&&n.downvotes_count--):(i==="upvote"&&n.upvotes_count--,i==="downvote"&&n.downvotes_count--,n.user_vote=a,a==="upvote"&&n.upvotes_count++,a==="downvote"&&n.downvotes_count++);const I=await f.post("https://klegg-app-whh7m.ondigitalocean.app/api/comments/".concat(e,"/vote"),{vote_type:a},{headers:_(),timeout:1e4});v.value[u]={...v.value[u],upvotes_count:I.data.upvotes_count,downvotes_count:I.data.downvotes_count,user_vote:I.data.user_vote}}catch(u){console.error("Error voting on comment:",u),z(O.value)}finally{S.value=!1}}},Z=async e=>{w.value=!0,x.value=!1;try{const a=await f.post("https://klegg-app-whh7m.ondigitalocean.app/api/notifications/".concat(y,"/reactions"),{reaction_type:e},{headers:_(),timeout:1e4});s.value&&(s.value.reaction_counts=a.data.reaction_counts,s.value.user_reaction={reaction_type:e},P.value=a.data.reaction_id,console.log("Reaction added:",P.value))}catch(a){console.error("Error adding reaction:",a)}finally{w.value=!1}},ce=async()=>{w.value=!0;try{const e=await f.delete("https://klegg-app-whh7m.ondigitalocean.app/api/notifications/".concat(y,"/delete_reaction"),{headers:_(),timeout:1e4});s.value&&(s.value.reaction_counts=e.data.reaction_counts,P.value=0,s.value.user_reaction=null)}catch(e){console.error("Error removing reaction:",e)}finally{w.value=!1}},_=()=>({"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer ".concat(ae)}),de=e=>{var a;if(console.error("Error fetching data:",e),f.isAxiosError(e)){if(((a=e.response)==null?void 0:a.status)===401){ne.replace("/"),M.show({text:"Session expired. Please login again",position:"top",duration:"long"});return}if(e.code==="ECONNABORTED"){M.show({text:"Request timeout. Please try again",position:"top"});return}}M.show({text:"Failed to load data. Please try again later",position:"top"})},G=e=>{const a=e.matches;we(a)},K=()=>{const e=window.matchMedia("(prefers-color-scheme: dark)");return G(e),e.addEventListener("change",G),e};return fe(()=>{K(),J(),j.value=localStorage.getItem("global_id")?Number(localStorage.getItem("global_id")):0}),_e(async()=>{K()}),(e,a)=>{const u=ke("ion-buttons");return r(),p(t(ge),null,{default:l(()=>[o(t(Ce),null,{default:l(()=>[o(t(ye),null,{default:l(()=>[o(u,{slot:"start"},{default:l(()=>[o(t(Ie))]),_:1}),o(t(be),null,{default:l(()=>[...a[3]||(a[3]=[b(" Notification ",-1)])]),_:1})]),_:1})]),_:1}),o(t(Y),{fullscreen:!0},{default:l(()=>[R.value?(r(),C("div",Ze,[o(t(N),{name:"crescent",color:"primary"})])):E.value?(r(),C("div",Ge,[o(t(g),{icon:t(Se),color:"danger",size:"large"},null,8,["icon"]),o(t($e),null,{default:l(()=>[...a[4]||(a[4]=[d("h3",null,"Error Loading Notification",-1),d("p",null,"Please try again later",-1)])]),_:1}),o(t(h),{fill:"clear",onClick:J},{default:l(()=>[...a[5]||(a[5]=[b("Retry",-1)])]),_:1})])):s.value?(r(),C("div",Ke,[o(t(xe),{class:"notification-card"},{default:l(()=>[o(t(Ne),null,{default:l(()=>[o(t(Re),{class:"notification-title"},{default:l(()=>[b(m(s.value.title),1)]),_:1}),o(t(Ee),null,{default:l(()=>[b(m(q(s.value.created_at)),1)]),_:1})]),_:1}),o(t(De),null,{default:l(()=>[d("p",Qe,m(s.value.body),1),d("div",Xe,[(r(!0),C(A,null,L(s.value.reaction_counts,(n,i)=>(r(),p(t(h),{key:i,fill:"clear",size:"small",onClick:I=>ue(i),color:V.value===i?"primary":"medium",disabled:w.value},{default:l(()=>[w.value&&V.value===i?(r(),p(t(N),{key:0,name:"dots",slot:"start"})):(r(),p(t(g),{key:1,icon:F(i),slot:"start"},null,8,["icon"])),b(" "+m(n),1)]),_:2},1032,["onClick","color","disabled"]))),128)),o(t(h),{fill:"clear",size:"small",onClick:a[0]||(a[0]=n=>x.value=!0),disabled:w.value},{default:l(()=>[o(t(g),{icon:t(Oe),slot:"icon-only"},null,8,["icon"])]),_:1},8,["disabled"])])]),_:1})]),_:1}),d("div",Ye,[o(t(Pe),null,{default:l(()=>[o(t(Ve),null,{default:l(()=>[o(t(Q),null,{default:l(()=>[b("Comments ("+m(s.value.comments_count)+")",1)]),_:1})]),_:1}),(r(!0),C(A,null,L(v.value,n=>(r(),p(t(X),{key:n.id,class:"comment-item"},{default:l(()=>[o(t(Ue),{slot:"start",style:{"margin-left":"20px"}},{default:l(()=>[d("img",{src:n.avatar||"/assets/img/default-avatar.svg"},null,8,et)]),_:2},1024),o(t(Q),null,{default:l(()=>[d("h3",null,m(n.user_name),1),d("p",null,m(n.comment_body),1),d("p",tt,m(q(n.created_at)),1)]),_:2},1024),d("div",at,[o(t(h),{fill:"clear",size:"small",onClick:i=>W(n.id,"upvote"),disabled:S.value},{default:l(()=>[o(t(g),{icon:t(ee),color:n.user_vote==="upvote"?"primary":"medium"},null,8,["icon","color"]),d("span",ot,m(n.upvotes_count),1)]),_:2},1032,["onClick","disabled"]),o(t(h),{fill:"clear",size:"small",onClick:i=>W(n.id,"downvote"),disabled:S.value},{default:l(()=>[o(t(g),{icon:t(je),color:n.user_vote==="downvote"?"danger":"medium"},null,8,["icon","color"]),d("span",nt,m(n.downvotes_count),1)]),_:2},1032,["onClick","disabled"])]),n.user_id===j.value?(r(),p(t(h),{key:0,fill:"clear",color:"danger",onClick:i=>re(n.id),disabled:$.value===n.id},{default:l(()=>[$.value===n.id?(r(),p(t(N),{key:0,name:"dots",slot:"icon-only"})):(r(),p(t(g),{key:1,icon:t(Fe),slot:"icon-only"},null,8,["icon"]))]),_:2},1032,["onClick","disabled"])):T("",!0)]),_:2},1024))),128)),o(t(ze),{onIonInfinite:se,threshold:"100px",disabled:!U.value},{default:l(()=>[o(t(Be),{"loading-spinner":"bubbles","loading-text":"Loading more comments..."})]),_:1},8,["disabled"])]),_:1})]),d("div",lt,[o(t(X),null,{default:l(()=>[o(t(Te),{modelValue:k.value,"onUpdate:modelValue":a[1]||(a[1]=n=>k.value=n),placeholder:"Add a comment...","auto-grow":""},null,8,["modelValue"]),o(t(h),{slot:"end",fill:"clear",disabled:!k.value.trim(),onClick:ie},{default:l(()=>[D.value?(r(),p(t(N),{key:0,slot:"start",name:"dots"})):T("",!0),o(t(g),{icon:t(Ae),color:"primary"},null,8,["icon"])]),_:1},8,["disabled"])]),_:1})])])):T("",!0),o(t(Le),{"is-open":x.value,onDidDismiss:a[2]||(a[2]=n=>x.value=!1)},{default:l(()=>[o(t(Y),null,{default:l(()=>[o(t(Me),null,{default:l(()=>[o(t(He),null,{default:l(()=>[(r(),C(A,null,L(le,n=>o(t(qe),{key:n,size:"auto",onClick:i=>Z(n)},{default:l(()=>[o(t(h),{fill:"clear"},{default:l(()=>[o(t(g),{icon:F(n),size:"large"},null,8,["icon"])]),_:2},1024)]),_:2},1032,["onClick"])),64))]),_:1})]),_:1})]),_:1})]),_:1},8,["is-open"])]),_:1})]),_:1})}}}),ct=We(st,[["__scopeId","data-v-352e1400"]]);export{ct as default};
