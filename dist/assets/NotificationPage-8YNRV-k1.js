import{d as be,r as d,ao as Ie,c as Ce,o as $e,P as xe,a as w,w as l,u as a,I as De,b as _,e as Se,f as Ee,g as o,h as Re,L as Ne,aq as Oe,m as Le,B as x,s as Pe,v as y,a9 as E,x as O,p,a1 as Be,a2 as ze,l as u,n as g,y as Te,z as Ue,A as Ve,t as f,aQ as Fe,D as Ae,a6 as j,a0 as Me,a8 as H,T as je,aH as He,R as J,S as W,aR as Je,a3 as We,aS as qe,a4 as Ge,a5 as Ze,aT as Qe,aU as Xe,aV as Ye,N as q,aW as Ke,aX as et,aY as tt,aG as at,O as c,k as ot,ab as re,aZ as nt,a_ as lt,a$ as st,ac as it,ad as ue,_ as rt}from"./index-D6yZBIDx.js";import{T as D}from"./index-D-N4iO5a.js";const ut={key:0,class:"loading-container"},ct={key:1,class:"error-state"},dt={key:2},mt={class:"notification-body"},vt={key:0,class:"attachment-container"},pt={class:"image-attachment"},ft=["src","alt"],_t={key:1,class:"file-attachment"},gt={class:"reactions-container"},ht={class:"comments-section"},wt=["src"],yt={class:"comment-date"},kt={slot:"end",class:"vote-buttons"},bt={class:"vote-count"},It={class:"vote-count"},Ct={class:"comment-input-container"},$t={key:0,class:"modal-content"},xt=["src","alt"],Dt=be({__name:"NotificationPage",setup(St){const ce=localStorage.getItem("parisklegg_token")||"",G=localStorage.getItem("parisklegg_user");G&&JSON.parse(G);let L=null;const P=d({name:"",id:0,otp:0,phone:""}),de=Ie(),me=Se(),I=Number(de.params.id),B=d(!0),z=d(!1),T=d(!1),k=d(!1),S=d(!1),s=d(null),v=d([]),U=d(1),Z=d(!0),C=d(""),R=d(null),N=d(!1),V=d(null),Q=d(0),b=d(null),ve=["like","heart","thumbs-up"],F=Ce(()=>{var e,t;return((t=(e=s.value)==null?void 0:e.user_reaction)==null?void 0:t.reaction_type)||null}),X=e=>({like:ue,heart:it,"thumbs-up":re})[e]||ue,Y=e=>{if(!e)return"Just now";const t=e.replace(/\.\d{6}Z$/,""),i=new Date(t);if(isNaN(i.getTime()))return"Invalid date";const n=i.toLocaleString("en-US",{month:"short"}),r=i.getDate(),m=String(i.getHours()).padStart(2,"0"),$=String(i.getMinutes()).padStart(2,"0");return"".concat(n," ").concat(r,", ").concat(m,":").concat($)},K=e=>"https://school.klgilc.com/api/files/".concat(e,"/view"),ee=e=>[".png",".jpg",".jpeg",".gif",".webp",".bmp",".svg"].some(i=>e.toLowerCase().endsWith(i)),pe=e=>{ee(e)?b.value=e:A(e)},fe=e=>{const t=e.target;t.style.opacity="0.5",t.alt="Failed to load image"},A=async e=>{try{const t=await D.show({text:"Preparing download...",position:"top"}),i=await _.get("https://school.klgilc.com/api/files/".concat(e,"/download"),{headers:h(),responseType:"blob",timeout:3e4}),n=new Blob([i.data]),r=window.URL.createObjectURL(n),m=document.createElement("a");m.href=r;const $=i.headers["content-disposition"];let se=e;if($){const ie=$.match(/filename="?(.+)"?/);ie&&(se=ie[1])}m.download=se,document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(r),await D.show({text:"Download started successfully",position:"top",duration:"short"})}catch(t){console.error("Download error:",t),await D.show({text:"Download failed. Please try again.",position:"top",duration:"long"})}},te=async()=>{try{B.value=!0,z.value=!1;const e=await _.get("https://klegg-app-whh7m.ondigitalocean.app/api/notifications/".concat(I),{headers:h(),timeout:2e4});s.value=e.data,console.log("Notification loaded:",e.data),e.data.is_read===0&&await _.post("https://klegg-app-whh7m.ondigitalocean.app/api/notifications/".concat(I,"/read"),{},{headers:h(),timeout:1e4}),await M()}catch(e){console.error("Error loading notification:",e),ke(e),z.value=!0}finally{B.value=!1}},M=async(e=1)=>{try{const t=await _.get("https://klegg-app-whh7m.ondigitalocean.app/api/notifications/".concat(I,"/comments"),{params:{page:e},headers:h(),timeout:1e4});e===1?v.value=t.data.data:v.value=[...v.value,...t.data.data],U.value=e,Z.value=!!t.data.next_page_url}catch(t){console.error("Error loading comments:",t)}},_e=async e=>{await M(U.value+1),e.target.complete()},ge=async()=>{if(C.value.trim()){T.value=!0;try{const e=await _.post("https://klegg-app-whh7m.ondigitalocean.app/api/notifications/".concat(I,"/create_comment"),{comment_body:C.value},{headers:h(),timeout:1e4}),t={id:e.data.comment.id,comment_body:e.data.comment.comment_body,created_at:e.data.comment.created_at,user_id:e.data.comment.user_id,user_name:e.data.comment.user_name,avatar:e.data.comment.avatar||null,upvotes_count:0,downvotes_count:0,user_vote:null};v.value.unshift(t),C.value="",s.value&&(s.value.comments_count+=1)}catch(e){console.error("Error adding comment:",e)}finally{T.value=!1}}},he=async e=>{R.value=e;try{await _.delete("https://klegg-app-whh7m.ondigitalocean.app/api/comments/".concat(e),{headers:h(),timeout:1e4}),v.value=v.value.filter(t=>t.id!==e),s.value&&(s.value.comments_count-=1)}catch(t){console.error("Error deleting comment:",t)}finally{R.value=null}},we=async e=>{F.value===e?await ye():await oe(e)},ae=async(e,t)=>{if(!S.value){S.value=!0;try{const i=v.value.findIndex($=>$.id===e);if(i===-1)return;const n=v.value[i],r=n.user_vote;r===t?(n.user_vote=null,t==="upvote"&&n.upvotes_count--,t==="downvote"&&n.downvotes_count--):(r==="upvote"&&n.upvotes_count--,r==="downvote"&&n.downvotes_count--,n.user_vote=t,t==="upvote"&&n.upvotes_count++,t==="downvote"&&n.downvotes_count++);const m=await _.post("https://klegg-app-whh7m.ondigitalocean.app/api/comments/".concat(e,"/vote"),{vote_type:t},{headers:h(),timeout:1e4});v.value[i]={...v.value[i],upvotes_count:m.data.upvotes_count,downvotes_count:m.data.downvotes_count,user_vote:m.data.user_vote}}catch(i){console.error("Error voting on comment:",i),M(U.value)}finally{S.value=!1}}},oe=async e=>{k.value=!0,N.value=!1;try{const t=await _.post("https://klegg-app-whh7m.ondigitalocean.app/api/notifications/".concat(I,"/reactions"),{reaction_type:e},{headers:h(),timeout:1e4});s.value&&(s.value.reaction_counts=t.data.reaction_counts,s.value.user_reaction={reaction_type:e},V.value=t.data.reaction_id,console.log("Reaction added:",V.value))}catch(t){console.error("Error adding reaction:",t)}finally{k.value=!1}},ye=async()=>{k.value=!0;try{const e=await _.delete("https://klegg-app-whh7m.ondigitalocean.app/api/notifications/".concat(I,"/delete_reaction"),{headers:h(),timeout:1e4});s.value&&(s.value.reaction_counts=e.data.reaction_counts,V.value=0,s.value.user_reaction=null)}catch(e){console.error("Error removing reaction:",e)}finally{k.value=!1}},h=()=>({"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer ".concat(ce)}),ke=e=>{var t;if(console.error("Error fetching data:",e),_.isAxiosError(e)){if(((t=e.response)==null?void 0:t.status)===401){me.replace("/"),D.show({text:"Session expired. Please login again",position:"top",duration:"long"});return}if(e.code==="ECONNABORTED"){D.show({text:"Request timeout. Please try again",position:"top"});return}}D.show({text:"Failed to load data. Please try again later",position:"top"})},ne=e=>{const t=e.matches;Ee(t)},le=()=>{const e=window.matchMedia("(prefers-color-scheme: dark)");return ne(e),e.addEventListener("change",ne),e};return $e(()=>{le(),te();const e=localStorage.getItem("parisklegg_user");if(e){const t=JSON.parse(e);t&&(P.value.name=t.fullname,P.value.id=t.user_id,P.value.email=t.username,L=t.user_id)}Q.value=L?Number(L):0}),xe(async()=>{le()}),(e,t)=>{const i=Ne("ion-buttons");return c(),w(a(De),null,{default:l(()=>[o(a(Pe),null,{default:l(()=>[o(a(Re),null,{default:l(()=>[o(i,{slot:"start"},{default:l(()=>[o(a(Oe))]),_:1}),o(a(Le),null,{default:l(()=>[...t[8]||(t[8]=[x(" Notification ",-1)])]),_:1})]),_:1})]),_:1}),o(a(q),{fullscreen:!0},{default:l(()=>[B.value?(c(),y("div",ut,[o(a(O),{name:"crescent",color:"primary"})])):z.value?(c(),y("div",ct,[o(a(p),{icon:a(Be),color:"danger",size:"large"},null,8,["icon"]),o(a(ze),null,{default:l(()=>[...t[9]||(t[9]=[u("h3",null,"Error Loading Notification",-1),u("p",null,"Please try again later",-1)])]),_:1}),o(a(g),{fill:"clear",onClick:te},{default:l(()=>[...t[10]||(t[10]=[x("Retry",-1)])]),_:1})])):s.value?(c(),y("div",dt,[o(a(Te),{class:"notification-card"},{default:l(()=>[o(a(Ue),null,{default:l(()=>[o(a(Ve),{class:"notification-title"},{default:l(()=>[x(f(s.value.title),1)]),_:1}),o(a(Fe),null,{default:l(()=>[x(f(Y(s.value.created_at)),1)]),_:1})]),_:1}),o(a(Ae),null,{default:l(()=>[u("p",mt,f(s.value.body),1),s.value.attachment&&ee(s.value.attachment)?(c(),y("div",vt,[u("div",pt,[u("img",{src:K(s.value.attachment),alt:s.value.attachment,loading:"lazy",onClick:t[0]||(t[0]=n=>pe(s.value.attachment)),class:"attachment-image",onError:fe},null,40,ft)])])):s.value.attachment?(c(),y("div",_t,[o(a(j),{button:"",onClick:t[2]||(t[2]=n=>A(s.value.attachment))},{default:l(()=>[o(a(p),{icon:a(Me),slot:"start",color:"primary"},null,8,["icon"]),o(a(H),null,{default:l(()=>[u("h3",null,f(s.value.attachment),1),t[11]||(t[11]=u("p",null,"File Attachment",-1))]),_:1}),o(a(g),{fill:"clear",slot:"end",onClick:t[1]||(t[1]=je(n=>A(s.value.attachment),["stop"]))},{default:l(()=>[o(a(p),{icon:a(He)},null,8,["icon"])]),_:1})]),_:1})])):E("",!0),u("div",gt,[(c(!0),y(J,null,W(s.value.reaction_counts,(n,r)=>(c(),w(a(g),{key:r,fill:"clear",size:"small",onClick:m=>we(r),color:F.value===r?"primary":"medium",disabled:k.value},{default:l(()=>[k.value&&F.value===r?(c(),w(a(O),{key:0,name:"dots",slot:"start"})):(c(),w(a(p),{key:1,icon:X(r),slot:"start"},null,8,["icon"])),x(" "+f(n),1)]),_:2},1032,["onClick","color","disabled"]))),128)),o(a(g),{fill:"clear",size:"small",onClick:t[3]||(t[3]=n=>N.value=!0),disabled:k.value},{default:l(()=>[o(a(p),{icon:a(Je),slot:"icon-only"},null,8,["icon"])]),_:1},8,["disabled"])])]),_:1})]),_:1}),u("div",ht,[o(a(We),null,{default:l(()=>[o(a(qe),null,{default:l(()=>[o(a(H),null,{default:l(()=>[x("Comments ("+f(s.value.comments_count)+")",1)]),_:1})]),_:1}),(c(!0),y(J,null,W(v.value,n=>(c(),w(a(j),{key:n.id,class:"comment-item"},{default:l(()=>[o(a(ot),{slot:"start",style:{"margin-left":"20px"}},{default:l(()=>[u("img",{src:n.avatar||"/assets/img/default-avatar.svg"},null,8,wt)]),_:2},1024),o(a(H),null,{default:l(()=>[u("h3",null,f(n.user_name),1),u("p",null,f(n.comment_body),1),u("p",yt,f(Y(n.created_at)),1)]),_:2},1024),u("div",kt,[o(a(g),{fill:"clear",size:"small",onClick:r=>ae(n.id,"upvote"),disabled:S.value},{default:l(()=>[o(a(p),{icon:a(re),color:n.user_vote==="upvote"?"primary":"medium"},null,8,["icon","color"]),u("span",bt,f(n.upvotes_count),1)]),_:2},1032,["onClick","disabled"]),o(a(g),{fill:"clear",size:"small",onClick:r=>ae(n.id,"downvote"),disabled:S.value},{default:l(()=>[o(a(p),{icon:a(nt),color:n.user_vote==="downvote"?"danger":"medium"},null,8,["icon","color"]),u("span",It,f(n.downvotes_count),1)]),_:2},1032,["onClick","disabled"])]),n.user_id===Q.value?(c(),w(a(g),{key:0,fill:"clear",color:"danger",onClick:r=>he(n.id),disabled:R.value===n.id},{default:l(()=>[R.value===n.id?(c(),w(a(O),{key:0,name:"dots",slot:"icon-only"})):(c(),w(a(p),{key:1,icon:a(lt),slot:"icon-only"},null,8,["icon"]))]),_:2},1032,["onClick","disabled"])):E("",!0)]),_:2},1024))),128)),o(a(Ge),{onIonInfinite:_e,threshold:"100px",disabled:!Z.value},{default:l(()=>[o(a(Ze),{"loading-spinner":"bubbles","loading-text":"Loading more comments..."})]),_:1},8,["disabled"])]),_:1})]),u("div",Ct,[o(a(j),null,{default:l(()=>[o(a(Qe),{modelValue:C.value,"onUpdate:modelValue":t[4]||(t[4]=n=>C.value=n),placeholder:"Add a comment...","auto-grow":""},null,8,["modelValue"]),o(a(g),{slot:"end",fill:"clear",disabled:!C.value.trim(),onClick:ge},{default:l(()=>[T.value?(c(),w(a(O),{key:0,slot:"start",name:"dots"})):E("",!0),o(a(p),{icon:a(Xe),color:"primary"},null,8,["icon"])]),_:1},8,["disabled"])]),_:1})])])):E("",!0),o(a(Ye),{"is-open":N.value,onDidDismiss:t[5]||(t[5]=n=>N.value=!1)},{default:l(()=>[o(a(q),null,{default:l(()=>[o(a(Ke),null,{default:l(()=>[o(a(et),null,{default:l(()=>[(c(),y(J,null,W(ve,n=>o(a(st),{key:n,size:"auto",onClick:r=>oe(n)},{default:l(()=>[o(a(g),{fill:"clear"},{default:l(()=>[o(a(p),{icon:X(n),size:"large"},null,8,["icon"])]),_:2},1024)]),_:2},1032,["onClick"])),64))]),_:1})]),_:1})]),_:1})]),_:1},8,["is-open"]),o(a(tt),{"is-open":!!b.value,onDidDismiss:t[7]||(t[7]=n=>b.value=null),class:"image-modal"},{default:l(()=>[o(a(q),null,{default:l(()=>[b.value?(c(),y("div",$t,[u("img",{src:K(b.value),alt:b.value,class:"modal-image"},null,8,xt),o(a(g),{fill:"clear",color:"light",class:"close-btn",onClick:t[6]||(t[6]=n=>b.value=null)},{default:l(()=>[o(a(p),{icon:a(at)},null,8,["icon"])]),_:1})])):E("",!0)]),_:1})]),_:1},8,["is-open"])]),_:1})]),_:1})}}}),Nt=rt(Dt,[["__scopeId","data-v-076423c1"]]);export{Nt as default};
